#!/bin/bash
# TeyMCP-Server å¿«é€Ÿå¯åŠ¨è„šæœ¬ - å›ºå®šç«¯å£1215
# Author: zf13883922290
# GitHub: https://github.com/zf13883922290/TeyMCP-Server

cd /home/sun/TeyMCP-Server || exit 1

# æ˜¾ç¤ºLogoå’Œé¡¹ç›®ä¿¡æ¯
clear
echo ""
echo "  _____         __  __  ____ ____  "
echo " |_   _|__ _   _|  \/  |/ ___|  _ \ "
echo "   | |/ _ \ | | | |\/| | |   | |_) |"
echo "   | |  __/ |_| | |  | | |___|  __/ "
echo "   |_|\___|\__, |_|  |_|\____|_|    "
echo "           |___/                     "
echo "    ____                            "
echo "   / ___|  ___ _ ____   _____ _ __  "
echo "   \___ \ / _ \ '__\ \ / / _ \ '__| "
echo "    ___) |  __/ |   \ V /  __/ |    "
echo "   |____/ \___|_|    \_/ \___|_|    "
echo ""
echo "  ğŸŒŸ The One MCP to Rule Them All ğŸŒŸ"
echo ""
echo "  ğŸ“¦ Version: 2.0"
echo "  ğŸ‘¤ Author: zf13883922290"
echo "  ğŸ”— GitHub: https://github.com/zf13883922290/TeyMCP-Server"
echo "  ğŸ“š Docs: https://github.com/zf13883922290/TeyMCP-Server/wiki"
echo ""
echo "=========================================="
echo ""

# 1. æ€æ­»æ—§è¿›ç¨‹
echo "ğŸ” æ­¥éª¤1: æ¸…ç†æ—§è¿›ç¨‹..."
pkill -9 -f "python.*src/main.py" 2>/dev/null && echo "   âœ… å·²åœæ­¢æ—§æœåŠ¡å™¨" || echo "   â„¹ï¸  æ²¡æœ‰è¿è¡Œä¸­çš„æœåŠ¡å™¨"

# 2. å¯åŠ¨æ–°æœåŠ¡å™¨
echo ""
echo "ğŸš€ æ­¥éª¤2: å¯åŠ¨æœåŠ¡å™¨..."
source venv/bin/activate
nohup python src/main.py > /tmp/teymcp_startup.log 2>&1 &
SERVER_PID=$!
echo $SERVER_PID > /tmp/teymcp.pid

# 3. ç­‰å¾…å¯åŠ¨
echo ""
echo "â³ æ­¥éª¤3: ç­‰å¾…æœåŠ¡å™¨åˆå§‹åŒ–..."
sleep 3

# æ˜¾ç¤ºå¯åŠ¨çŠ¶æ€
if ps -p $SERVER_PID > /dev/null 2>&1; then
    echo ""
    echo "=========================================="
    echo "        âœ… TeyMCP-Server å¯åŠ¨æˆåŠŸ!"
    echo "=========================================="
    echo ""
    echo "ğŸ“Š è¿è¡Œä¿¡æ¯:"
    echo "   â€¢ è¿›ç¨‹ID: $SERVER_PID"
    echo "   â€¢ ç›‘å¬ç«¯å£: 1215"
    echo "   â€¢ é˜²ç«å¢™: âœ… å·²å¼€å¯"
    echo ""
    echo "â³ æ­£åœ¨åˆå§‹åŒ–MCPæœåŠ¡å™¨(12ç§’)..."
    sleep 12
    echo ""
    echo "=========================================="
    echo "          ğŸ“Š MCPæœåŠ¡å™¨åŠ è½½çŠ¶æ€"
    echo "=========================================="
    echo ""
    
    # æå–åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    SUCCESS_COUNT=$(tail -10 /tmp/teymcp_startup.log | grep "æˆåŠŸåŠ è½½" | grep -o "[0-9]\+" | head -1)
    FAILED_COUNT=$(tail -10 /tmp/teymcp_startup.log | grep "åŠ è½½å¤±è´¥" | grep -o "[0-9]\+" | head -1)
    TOOLS_COUNT=$(tail -10 /tmp/teymcp_startup.log | grep "æä¾›å·¥å…·" | grep -o "[0-9]\+" | head -1)
    # æå–åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    SUCCESS_COUNT=$(tail -20 /tmp/teymcp_startup.log | grep "æˆåŠŸåŠ è½½" | sed 's/.*æˆåŠŸåŠ è½½: \([0-9]\+\).*/\1/')
    FAILED_COUNT=$(tail -20 /tmp/teymcp_startup.log | grep "åŠ è½½å¤±è´¥" | sed 's/.*åŠ è½½å¤±è´¥: \([0-9]\+\).*/\1/')
    TOOLS_COUNT=$(tail -20 /tmp/teymcp_startup.log | grep "æä¾›å·¥å…·" | sed 's/.*æä¾›å·¥å…·: \([0-9]\+\).*/\1/')
    fi
    
    if [ -n "$FAILED_COUNT" ] && [ "$FAILED_COUNT" != "0" ]; then
        echo "âš ï¸  åŠ è½½å¤±è´¥: $FAILED_COUNT ä¸ªMCPæœåŠ¡å™¨"
    fi
    
    if [ -n "$TOOLS_COUNT" ]; then
        echo "ğŸ”§ å¯ç”¨å·¥å…·: $TOOLS_COUNT ä¸ª"
    fi
    
    echo ""
    echo "è¯¦ç»†æ—¥å¿—: tail -f /tmp/teymcp_startup.log"
    echo ""
    echo "=========================================="
    echo "          ğŸ“¦ ç¤¾åŒºä¸æ”¯æŒ"
    echo "=========================================="
    echo ""
    echo "ğŸ”— é¡¹ç›®èµ„æº:"
    echo "   â€¢ GitHubä»“åº“:   https://github.com/zf13883922290/TeyMCP-Server"
    echo "   â€¢ é—®é¢˜åé¦ˆ:     https://github.com/zf13883922290/TeyMCP-Server/issues"
    echo "   â€¢ è´¡çŒ®æŒ‡å—:     https://github.com/zf13883922290/TeyMCP-Server/blob/main/CONTRIBUTING.md"
    echo "   â€¢ å¿«é€Ÿå¼€å§‹:     æŸ¥çœ‹ QUICKSTART.md"
    echo ""
    echo "ğŸ“§ è”ç³»æ–¹å¼:"
    echo "   â€¢ ä½œè€…: zf13883922290"
    echo "   â€¢ é‚®ç®±: (åœ¨GitHub ProfileæŸ¥çœ‹)"
    echo ""
    echo "=========================================="
    echo "          ğŸŒ è®¿é—®åœ°å€"
    echo "=========================================="
    echo ""
    echo "ğŸ“± æ ¸å¿ƒåŠŸèƒ½:"
    echo "   ğŸ  ç®¡ç†é¢æ¿:    http://localhost:1215"
    echo "   ğŸ“š APIæ–‡æ¡£:     http://localhost:1215/api/docs"
    echo "   ğŸ“Š çŠ¶æ€ç›‘æ§:    http://localhost:1215/api/status"
    echo "   ğŸ“ æ—¥å¿—æ¥å£:    http://localhost:1215/api/logs"
    echo "   ğŸ”§ å·¥å…·åˆ—è¡¨:    http://localhost:1215/api/tools"
    echo "   ğŸ–¥ï¸  æœåŠ¡å™¨åˆ—è¡¨:  http://localhost:1215/api/servers"
    echo ""
    echo "ğŸŒ å¤–éƒ¨è®¿é—® (å¦‚æœéœ€è¦):"
    echo "   æ›¿æ¢ localhost ä¸ºæœåŠ¡å™¨IPåœ°å€"
    echo "   ä¾‹å¦‚: http://YOUR_IP:1215"
    echo ""
    echo "=========================================="
    echo "          âš™ï¸  é…ç½®ä¸ç®¡ç†"
    echo "=========================================="
    echo ""
    echo "ğŸ“‚ é…ç½®æ–‡ä»¶:"
    echo "   â€¢ åº”ç”¨é…ç½®:     config/app.yaml"
    echo "   â€¢ MCPæœåŠ¡å™¨:    config/servers.yaml"
    echo "   â€¢ ç¯å¢ƒå˜é‡:     config/.env"
    echo ""
    echo "ğŸ“ æ—¥å¿—æ–‡ä»¶:"
    echo "   â€¢ å¯åŠ¨æ—¥å¿—:     /tmp/teymcp_startup.log"
    echo "   â€¢ æŒä¹…æ—¥å¿—:     data/logs/teymcp.log"
    echo ""
    echo "ğŸ› ï¸  ç®¡ç†å‘½ä»¤:"
    echo "   â€¢ æŸ¥çœ‹çŠ¶æ€:     bash service.sh status"
    echo "   â€¢ å®æ—¶æ—¥å¿—:     bash view_logs.sh"
    echo "   â€¢ åœæ­¢æœåŠ¡:     bash service.sh stop"
    echo "   â€¢ é‡å¯æœåŠ¡:     bash service.sh restart"
    echo ""
    echo "=========================================="
    echo "ğŸ‰ ä¸€åˆ‡å‡†å¤‡å°±ç»ª! è®¿é—® http://localhost:1215 å¼€å§‹ä½¿ç”¨"
    echo "=========================================="
    echo ""
else
    echo "âŒ å¯åŠ¨å¤±è´¥! æŸ¥çœ‹æ—¥å¿—: tail -50 /tmp/teymcp_startup.log"
    exit 1
fi
